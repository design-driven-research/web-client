{"version":3,"sources":["rdd/services/event_bus.cljs"],"mappings":"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","names":["cljs.core/not","mount.core/running-noop?","js/rdd","js/rdd.services","js/rdd.services.event-bus","js/rdd.services.event-bus.bus","mount.core/->DerefableState","mount.core/mount-it","rdd.services.event-bus/bus","mount.core/current-state","c","cljs.core.async.chan","js/console.log","rdd.services.event-bus/subscriptions","cljs.core.atom","rdd.services.event-bus/unsubscribe!","id","cljs.core.swap_BANG_","subs","cljs.core.filter","sub","cljs.core.not_EQ_","rdd.services.event-bus/subscribe!","topic","handler","cljs.core/random-uuid","cljs.core/conj","cljs.core.partial","rdd.services.event-bus/filter-by-topic","cljs.core._EQ_","p__47355","map__47356","cljs.core/--destructure-map","cljs.core.get","rdd.services.event-bus/process-queue","data","filtered-subs","cljs.core/deref","seq__47357","cljs.core/seq","chunk__47358","count__47359","i__47360","map__47373","temp__5753__auto__","cljs.core/chunked-seq?","c__4638__auto__","cljs.core/chunk-first","cljs.core/chunk-rest","cljs.core/count","map__47386","cljs.core/first","cljs.core/next","rdd.services.event-bus/start-queue","c__41327__auto__","cljs.core.async.impl.dispatch/run","f__41328__auto__","switch__41257__auto__","state_47425","state_val_47426","statearr-47443","statearr-47448","inst_47419","cljs.core.async.impl.ioc-helpers/return-chan","cljs.core.async.impl.ioc-helpers/take!","statearr-47470","inst_47415","statearr-47471","inst_47407","inst_47408","statearr-47476","statearr-47477","statearr-47482","state-machine__41258__auto__","ret-value__41259__auto__","result__41260__auto__","cljs.core/keyword-identical?","ex__41261__auto__","e47483","statearr-47485","statearr-47486","state__41329__auto__","statearr-47494","cljs.core.async.impl.ioc-helpers/USER-START-IDX","cljs.core.async.impl.ioc-helpers/run-state-machine-wrapped","rdd.services.event-bus/publish!","cljs.core.async.put_BANG_"],"sourcesContent":["(ns rdd.services.event-bus\n  (:require-macros\n   [mount.core :refer [defstate]]\n   [cljs.core.async.macros :refer (go)])\n  (:require\n\n   [cljs.core.async :refer [chan <! put!]]))\n\n(declare process-queue)\n\n(defstate bus\n  :start (let [c (chan)]\n           (js/console.log \"Starting event bus\")\n           c))\n\n(def subscriptions (atom []))\n\n(defn- unsubscribe!\n  [id]\n  (swap! subscriptions (fn [subs]\n                         (filter (fn [sub] (not= (:id sub) id)) subs))))\n\n(defn subscribe!\n  \"Subscribe to a topic on the global event bus. Pass in a topic as a string or keyword.\n   This returns an unsubscribe method\n   \n   (def unsubscribe (subscribe! :test (fn [] (js/console.log 'Called'))))\n\n   (publish! {:topic :test :data {:id 42}})\n   \n   (unsubscribe)\n   \"\n  [topic handler]\n  (let [id (random-uuid)]\n    (swap! subscriptions conj {:id id\n                               :topic topic\n                               :handler handler})\n    (partial unsubscribe! id)))\n\n(defn filter-by-topic [topic]\n  (fn [sub] (= (:topic sub) topic)))\n\n(defn process-queue\n  [{:keys [topic data]}]\n  (let [filtered-subs (filter (filter-by-topic topic) @subscriptions)]\n    (doseq [{:keys [handler]} filtered-subs]\n      (handler data))))\n\n(defn start-queue\n  [c]\n  (go\n    (while true\n      (process-queue (<! c)))))\n\n(start-queue @bus)\n\n(defn publish!\n  \"Publish a payload, {:topic :db-updated :data {}}\"\n  [data]\n  (put! @bus data))"]}